<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pulsenet - Post</title>
<style>
body { font-family:sans-serif; background:#FDFDFF; color:#111; margin:0; padding:20px; }
header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; }
/* Standardized Button Style */
.btn-dark { background:#111; color:#fff; padding:8px 12px; border-radius:5px; border:1px solid #ccc; cursor:pointer; font-family:inherit; text-decoration: none; display: inline-block; }
button { cursor:pointer; margin:5px; padding:8px 12px; border-radius:8px; border:none; font-family:inherit; display:none; }

#post { border:1px solid #ddd; padding:20px; border-radius:15px; margin-bottom:20px; }
.reaction-btn { margin-right:10px; cursor:pointer; display: inline-block; }
.comments { margin-top:20px; }
.comment { border-top:1px solid #eee; padding:12px 0; display:flex; justify-content:space-between; align-items:center; }

/* Changed: usernames now black and not underlined */
.comment b,
.author-name {
  margin-right:5px;
  cursor:pointer;
  color:#111;
  text-decoration:none;
}

#add-comment-btn, #back-btn { margin-top:10px; }
</style>
</head>
<body>

<header>
  <h1>Perspective</h1>
  <div id="top-buttons">
    <button id="login-btn">Login / Register</button>
    <button id="account-btn">Account</button>
    <button id="logout-btn">Logout</button>
  </div>
</header>

<div id="post">
  <h2 id="title"></h2>
  <p id="author-date" class="meta"></p>
  <p id="content"></p>
  <div id="reactions">
    <button class="reaction-btn" data-reaction="like">‚ù§Ô∏è 0</button>
    <button class="reaction-btn" data-reaction="fire">üî• 0</button>
    <button class="reaction-btn" data-reaction="insight">üí° 0</button>
  </div>
  <div class="comments" id="comments">
    <h3>Comments</h3>
    <div id="comments-list"></div>
    <button id="add-comment-btn" class="btn-dark">Add Comment</button>
  </div>
  <button id="back-btn" class="btn-dark" style="display:inline-block">Back</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBeslEXxh_2j9dLiwAgeRL3p11iqgWfMgo",
  authDomain: "pulsenet-d1fe0.firebaseapp.com",
  projectId: "pulsenet-d1fe0",
  storageBucket: "pulsenet-d1fe0.firebasestorage.app",
  messagingSenderId: "816402062445",
  appId: "1:816402062445:web:cf7ce7eb9c57c1ef2fb364"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "pulsenet-d1fe0";

const loginBtn = document.getElementById("login-btn");
const accountBtn = document.getElementById("account-btn");
const logoutBtn = document.getElementById("logout-btn");
const topButtons = document.getElementById("top-buttons");
const titleEl = document.getElementById("title");
const authorDateEl = document.getElementById("author-date");
const contentEl = document.getElementById("content");
const reactionsEl = document.getElementById("reactions");
const commentsListEl = document.getElementById("comments-list");
const addCommentBtn = document.getElementById("add-comment-btn");
const backBtn = document.getElementById("back-btn");

document.querySelector("header h1").onclick = () => {
  Array.from(topButtons.children).forEach(btn => {
    btn.style.display = btn.style.display === "none" ? "inline-block" : "none";
  });
};

loginBtn.onclick = ()=>window.location.href="login.html";
accountBtn.onclick = ()=>window.location.href="account.html";
logoutBtn.onclick = ()=>signOut(auth);
backBtn.onclick = ()=>window.history.back();

const params = new URLSearchParams(window.location.search);
const postId = params.get("id");

let currentUser = null;
onAuthStateChanged(auth, user=>{
  currentUser = user;
  addCommentBtn.style.display = user ? "inline-block" : "none";
});

async function loadPost(){
  const postDoc = await getDoc(doc(db,"artifacts",appId,"public","data","posts",postId));
  if(!postDoc.exists()) return alert("Post not found!");
  const post = postDoc.data();

  titleEl.textContent = post.title;
  contentEl.textContent = post.content;
  authorDateEl.innerHTML = `By <b class="author-name" data-uid="${post.authorId}">${escapeHTML(post.authorName || "Anonymous")}</b>`;

  // Author click
  document.addEventListener("click", function(e){
    if(e.target.classList.contains("author-name") || e.target.classList.contains("comment-user")){
      const uid = e.target.dataset.uid;
      if(uid){
        window.location.href = `account.html?uid=${uid}`;
      }
    }
  });

  // Reactions
  reactionsEl.querySelectorAll(".reaction-btn").forEach(btn=>{
    const type = btn.dataset.reaction;
    btn.textContent = `${btn.textContent.split(" ")[0]} ${post.reactions?.[type]||0}`;
    btn.onclick = async () => {
      if(!currentUser) return alert("Login to react!");
      await updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{ [`reactions.${type}`]: increment(1) });
      loadPost();
    };
  });

  // Comments List
  commentsListEl.innerHTML = "";
  (post.comments || []).sort((a,b)=> new Date(a.createdAt)-new Date(b.createdAt))
    .forEach(c=>{
      const div = document.createElement("div");
      div.className="comment";
      div.innerHTML = `
        <div>
          <b class="comment-user" data-uid="${c.authorId}">${escapeHTML(c.authorName)}</b>: ${escapeHTML(c.text)}
        </div>
        <button class="reply-btn btn-dark" style="display:inline-block; font-size: 0.8em; padding: 4px 8px;">Reply</button>`;

      div.querySelector(".reply-btn").onclick = ()=>{
        window.location.href = \`comments.html?postId=${postId}&replyTo=${encodeURIComponent(c.authorName)}\`;
      };
      commentsListEl.appendChild(div);
    });
}

addCommentBtn.onclick = () => window.location.href = \`comments.html?postId=${postId}\`;

function escapeHTML(str){
  return str?.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
}

loadPost();
</script>
</body>
</html>
