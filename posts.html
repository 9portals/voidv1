<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pulsenet - Post</title>
<style>
body { font-family:sans-serif; background:#FDFDFF; color:#111; margin:0; padding:20px; }
header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; }
button { cursor:pointer; margin:5px; padding:8px 12px; border-radius:8px; border:none; font-family:inherit; display:none; }
#post { border:1px solid #ddd; padding:20px; border-radius:15px; margin-bottom:20px; }
.reaction-btn { margin-right:10px; cursor:pointer; }
.comments { margin-top:20px; }
.comment { border-top:1px solid #eee; padding:8px 0; display:flex; justify-content:space-between; align-items:center; }
.comment b { margin-right:5px; cursor:pointer; color:blue; text-decoration:underline; }
#add-comment-btn, #back-btn { margin-top:10px; padding:8px 12px; border-radius:5px; border:1px solid #ccc; background:#111; color:#fff; cursor:pointer; display:none; }
.reply-btn { margin-left:5px; padding:2px 6px; border-radius:4px; cursor:pointer; background: #eee; border: 1px solid #ccc; }

/* New UI Styles */
#comment-ui { margin-top: 15px; display: none; flex-direction: column; gap: 10px; border-top: 2px solid #eee; padding-top: 15px; }
#comment-text { width: 100%; height: 80px; border-radius: 8px; border: 1px solid #ccc; padding: 10px; box-sizing: border-box; font-family: inherit; }
.comment-actions { display: flex; gap: 10px; }
#submit-comment-btn { background: #007bff; color: white; padding: 8px 16px; border-radius: 5px; border: none; cursor: pointer; }
#cancel-comment-btn { background: #eee; color: #333; padding: 8px 16px; border-radius: 5px; border: none; cursor: pointer; }
</style>
</head>
<body>

<header>
  <h1 style="cursor:pointer">Perspective</h1>
  <div id="top-buttons">
    <button id="login-btn">Login / Register</button>
    <button id="account-btn">Account</button>
    <button id="logout-btn">Logout</button>
  </div>
</header>

<div id="post">
  <h2 id="title"></h2>
  <p id="author-date" class="meta"></p>
  <p id="content"></p>
  <div id="reactions">
    <button class="reaction-btn" data-reaction="like">‚ù§Ô∏è 0</button>
    <button class="reaction-btn" data-reaction="fire">üî• 0</button>
    <button class="reaction-btn" data-reaction="insight">üí° 0</button>
  </div>

  <div class="comments" id="comments">
    <h3>Comments</h3>
    <div id="comments-list"></div>
    <button id="add-comment-btn">Add Comment</button>

    <div id="comment-ui">
      <textarea id="comment-text" placeholder="Write your thoughts..."></textarea>
      <div class="comment-actions">
        <button id="submit-comment-btn" style="display:inline-block">Post Comment</button>
        <button id="cancel-comment-btn" style="display:inline-block">Cancel</button>
      </div>
    </div>
  </div>
  <button id="back-btn" style="display:inline-block">Back</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBeslEXxh_2j9dLiwAgeRL3p11iqgWfMgo",
  authDomain: "pulsenet-d1fe0.firebaseapp.com",
  projectId: "pulsenet-d1fe0",
  storageBucket: "pulsenet-d1fe0.firebasestorage.app",
  messagingSenderId: "816402062445",
  appId: "1:816402062445:web:cf7ce7eb9c57c1ef2fb364"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "pulsenet-d1fe0";

// DOM
const loginBtn = document.getElementById("login-btn");
const accountBtn = document.getElementById("account-btn");
const logoutBtn = document.getElementById("logout-btn");
const topButtons = document.getElementById("top-buttons");

const titleEl = document.getElementById("title");
const authorDateEl = document.getElementById("author-date");
const contentEl = document.getElementById("content");
const reactionsEl = document.getElementById("reactions");
const commentsListEl = document.getElementById("comments-list");
const addCommentBtn = document.getElementById("add-comment-btn");
const backBtn = document.getElementById("back-btn");

// Comment UI DOM
const commentUi = document.getElementById("comment-ui");
const commentText = document.getElementById("comment-text");
const submitCommentBtn = document.getElementById("submit-comment-btn");
const cancelCommentBtn = document.getElementById("cancel-comment-btn");

// Toggle top buttons
document.querySelector("header h1").addEventListener("click", () => {
  Array.from(topButtons.children).forEach(btn => {
    btn.style.display = btn.style.display === "none" ? "inline-block" : "none";
  });
});

// Navigation
loginBtn.onclick = ()=>window.location.href="login.html";
accountBtn.onclick = ()=>window.location.href="account.html";
logoutBtn.onclick = ()=>signOut(auth);
backBtn.onclick = ()=>window.history.back();

// Get postId
const params = new URLSearchParams(window.location.search);
const postId = params.get("id");

// Auth state
let currentUser = null;
onAuthStateChanged(auth,user=>{
  currentUser = user;
  reactionsEl.querySelectorAll(".reaction-btn").forEach(btn => btn.disabled = !user);
  addCommentBtn.style.display = user ? "inline-block" : "none";
});

// Load post
async function loadPost(){
  const postDoc = await getDoc(doc(db,"artifacts",appId,"public","data","posts",postId));
  if(!postDoc.exists()) return alert("Post not found!");
  const post = postDoc.data();

  titleEl.textContent = post.title;
  contentEl.textContent = post.content;

  // Author clickable
  authorDateEl.innerHTML = `By <b class="author-name" data-uid="${post.authorId}">${escapeHTML(post.authorName || "Anonymous")}</b>`;
  document.querySelector(".author-name").onclick = e=>{
    const uid = e.target.dataset.uid;
    window.location.href = `account.html?uid=${uid}`;
  };

  // Post reactions
  reactionsEl.querySelectorAll(".reaction-btn").forEach(btn=>{
    const type = btn.dataset.reaction;
    btn.textContent = `${btn.textContent.split(" ")[0]} ${post.reactions?.[type]||0}`;
    btn.onclick = async () => {
      if(!currentUser) return alert("Login to react!");
      await updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{
        [`reactions.${type}`]: increment(1)
      });
      loadPost();
    };
  });

  // Comments
  commentsListEl.innerHTML = "";
  (post.comments || []).sort((a,b)=> new Date(a.createdAt)-new Date(b.createdAt))
    .forEach(c=>{
      const div = document.createElement("div");
      div.className="comment";
      div.innerHTML = `<span><b class="comment-user" data-uid="${c.authorId}">${escapeHTML(c.authorName)}</b>: ${escapeHTML(c.text)}</span>
        <button class="reply-btn">Reply</button>`;

      // Username click ‚Üí account
      div.querySelector(".comment-user").onclick = e=>{
        const uid = e.target.dataset.uid;
        window.location.href = `account.html?uid=${uid}`;
      };

      // Reply click ‚Üí Open UI with @handle
      div.querySelector(".reply-btn").onclick = ()=>{
        if(!currentUser) return alert("Login to reply!");
        showCommentUi(`@${c.authorName} `);
      };

      commentsListEl.appendChild(div);
    });
}

// Show/Hide Comment UI
function showCommentUi(initialText = ""){
  commentUi.style.display = "flex";
  addCommentBtn.style.display = "none";
  commentText.value = initialText;
  commentText.focus();
}

cancelCommentBtn.onclick = () => {
  commentUi.style.display = "none";
  addCommentBtn.style.display = "inline-block";
  commentText.value = "";
};

addCommentBtn.onclick = () => {
  showCommentUi();
};

submitCommentBtn.onclick = async () => {
  const text = commentText.value.trim();
  if(!text) return;
  if(!currentUser) return alert("Please login first.");

  const newComment = {
    authorId: currentUser.uid,
    authorName: currentUser.displayName || "Anonymous",
    text: text,
    createdAt: new Date().toISOString()
  };

  try {
    await updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId), {
      comments: arrayUnion(newComment)
    });
    commentText.value = "";
    commentUi.style.display = "none";
    addCommentBtn.style.display = "inline-block";
    loadPost();
  } catch(e) {
    console.error(e);
    alert("Error posting comment.");
  }
};

function escapeHTML(str){
  return str?.replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",
    '"':"&quot;","'":"&#039;"
  }[m]));
}

loadPost();
</script>
</body>
</html>
