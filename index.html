<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pulsenet Vanilla SPA</title>
<style>
body { font-family: sans-serif; background:#FDFDFF; color:#111; margin:0; padding:0;}
#app { max-width: 800px; margin:auto; padding:20px;}
.hidden { display:none;}
input, textarea, button { font-family:inherit; margin:5px 0; padding:8px; border-radius:5px; border:1px solid #ccc;}
button { cursor:pointer;}
.post { border:1px solid #ddd; padding:15px; border-radius:15px; margin-bottom:15px;}
.reaction-btn { margin-right:10px; cursor:pointer;}
.comment { margin-left:15px; font-size:14px;}
</style>
</head>
<body>

<div id="app">

<!-- AUTH -->
<div id="auth-section">
<h2 id="auth-title">Login</h2>
<form id="auth-form">
<input type="text" id="fullname" placeholder="Full Name" class="hidden"/>
<input type="email" id="email" placeholder="Email" required/>
<input type="password" id="password" placeholder="Password" required/>
<button type="submit" id="auth-btn">Login</button>
</form>
<button id="toggle-auth">Switch to Register</button>
<p id="auth-error" style="color:red"></p>
</div>

<!-- FEED -->
<div id="feed-section" class="hidden">
<div style="display:flex;justify-content:space-between;align-items:center;">
<h1>Perspective</h1>
<button id="logout-btn">Logout</button>
</div>
<button id="show-publish-btn">New Story</button>
<button id="show-account-btn">Account</button>
<div id="posts"></div>
</div>

<!-- PUBLISH -->
<div id="publish-section" class="hidden">
<h2>New Story</h2>
<form id="publish-form">
<input type="text" id="post-title" placeholder="Title" required/>
<textarea id="post-content" rows="8" placeholder="Tell your story..." required></textarea>
<button type="submit">Publish</button>
</form>
<button id="back-feed-btn">Back to Feed</button>
</div>

<!-- ACCOUNT -->
<div id="account-section" class="hidden">
<h2>Account</h2>
<p><b>Name:</b> <span id="display-name"></span></p>
<p><b>Email:</b> <span id="display-email"></span></p>
<input type="text" id="edit-display-name" placeholder="New Display Name"/>
<button id="save-display-btn">Save</button>
<button id="back-feed-btn2">Back to Feed</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword,
  signInWithEmailAndPassword, updateProfile,
  onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc,
  onSnapshot, doc, updateDoc,
  increment, serverTimestamp, arrayUnion
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBeslEXxh_2j9dLiwAgeRL3p11iqgWfMgo",
  authDomain: "pulsenet-d1fe0.firebaseapp.com",
  projectId: "pulsenet-d1fe0",
  storageBucket: "pulsenet-d1fe0.firebasestorage.app",
  messagingSenderId: "816402062445",
  appId: "1:816402062445:web:cf7ce7eb9c57c1ef2fb364",
  measurementId: "G-MDN646R1XP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "pulsenet-d1fe0";

const postsCol = collection(db,"artifacts",appId,"public","data","posts");

/* DOM */
const authSection = document.getElementById("auth-section");
const feedSection = document.getElementById("feed-section");
const publishSection = document.getElementById("publish-section");
const accountSection = document.getElementById("account-section");
const postsContainer = document.getElementById("posts");
const authError = document.getElementById("auth-error");

let isLogin = true;
let unsubscribePosts = null;

/* Toggle Auth */
document.getElementById("toggle-auth").onclick = () => {
  isLogin = !isLogin;
  document.getElementById("auth-title").innerText = isLogin?"Login":"Register";
  document.getElementById("auth-btn").innerText = isLogin?"Login":"Register";
  document.getElementById("fullname").classList.toggle("hidden");
};

/* Auth Submit */
document.getElementById("auth-form").onsubmit = async e=>{
  e.preventDefault();

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const fullnameInput = document.getElementById("fullname");

  try{
    if(isLogin){
      await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
    } else {
      const cred = await createUserWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
      await updateProfile(cred.user,{displayName:fullnameInput.value});
    }
    authError.innerText="";
  }catch(err){
    authError.innerText=err.message;
  }
};

/* Auth State */
onAuthStateChanged(auth,user=>{
  if(user){
    authSection.classList.add("hidden");
    feedSection.classList.remove("hidden");
    document.getElementById("display-name").innerText = user.displayName||"Anonymous";
    document.getElementById("display-email").innerText = user.email;
    startPostsListener();
  } else {
    if(unsubscribePosts) unsubscribePosts();
    authSection.classList.remove("hidden");
    feedSection.classList.add("hidden");
    publishSection.classList.add("hidden");
    accountSection.classList.add("hidden");
  }
});

/* Logout */
document.getElementById("logout-btn").onclick = ()=>signOut(auth);

/* Navigation */
document.getElementById("show-publish-btn").onclick = ()=>{
  feedSection.classList.add("hidden");
  publishSection.classList.remove("hidden");
};

document.getElementById("back-feed-btn").onclick = ()=>{
  publishSection.classList.add("hidden");
  feedSection.classList.remove("hidden");
};

document.getElementById("show-account-btn").onclick = ()=>{
  feedSection.classList.add("hidden");
  accountSection.classList.remove("hidden");
};

document.getElementById("back-feed-btn2").onclick = ()=>{
  accountSection.classList.add("hidden");
  feedSection.classList.remove("hidden");
};

/* Save Display Name */
document.getElementById("save-display-btn").onclick = async ()=>{
  const newName = document.getElementById("edit-display-name").value.trim();
  if(!newName) return;
  await updateProfile(auth.currentUser,{displayName:newName});
  document.getElementById("display-name").innerText = newName;
  document.getElementById("edit-display-name").value="";
};

/* Firestore Listener */
function startPostsListener(){
  if(unsubscribePosts) unsubscribePosts();

  unsubscribePosts = onSnapshot(postsCol,snapshot=>{
    postsContainer.innerHTML="";
    const docs = snapshot.docs.sort((a,b)=>{
      return (b.data().createdAt?.seconds||0) - (a.data().createdAt?.seconds||0);
    });

    docs.forEach(docSnap=>{
      const post = docSnap.data();
      const postId = docSnap.id;

      const div=document.createElement("div");
      div.className="post";

      div.innerHTML=`
        <h3>${escapeHTML(post.title)}</h3>
        <p>${escapeHTML(post.content)}</p>
        <button class="reaction-btn" data-type="like">‚ù§Ô∏è ${post.reactions?.like||0}</button>
        <button class="reaction-btn" data-type="fire">üî• ${post.reactions?.fire||0}</button>
        <button class="reaction-btn" data-type="insight">üí° ${post.reactions?.insight||0}</button>
        <div>
          <input placeholder="Add comment"/>
          <button class="send-comment">Send</button>
        </div>
        ${(post.comments||[]).map(c=>
          `<p class="comment"><b>${escapeHTML(c.authorName)}:</b> ${escapeHTML(c.text)}</p>`
        ).join("")}
      `;

      postsContainer.appendChild(div);

      div.querySelectorAll(".reaction-btn").forEach(btn=>{
        btn.onclick=()=>updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{
          [`reactions.${btn.dataset.type}`]: increment(1)
        });
      });

      const input = div.querySelector("input");
      const sendBtn = div.querySelector(".send-comment");

      sendBtn.onclick=()=>{
        if(!input.value.trim()) return;
        updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{
          comments: arrayUnion({
            text: input.value,
            authorName: auth.currentUser.displayName||"Anonymous",
            authorId: auth.currentUser.uid,
            createdAt: new Date().toISOString()
          })
        });
        input.value="";
      };
    });
  });
}

/* Publish */
document.getElementById("publish-form").onsubmit=async e=>{
  e.preventDefault();

  const titleInput = document.getElementById("post-title");
  const contentInput = document.getElementById("post-content");

  await addDoc(postsCol,{
    title: titleInput.value.trim(),
    content: contentInput.value.trim(),
    authorId: auth.currentUser.uid,
    authorName: auth.currentUser.displayName||"Anonymous",
    reactions:{like:0,fire:0,insight:0},
    comments:[],
    createdAt: serverTimestamp()
  });

  titleInput.value="";
  contentInput.value="";
  publishSection.classList.add("hidden");
  feedSection.classList.remove("hidden");
};

/* Escape HTML */
function escapeHTML(str){
  return str?.replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",
    '"':"&quot;","'":"&#039;"
  }[m]));
}
</script>
</body>
</html>
