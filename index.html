<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perspective - Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #FDFDFF; color: #111; }
        .post-card { transition: transform 0.2s; }
        .post-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="min-h-screen">

<div id="app">
    <!-- Header -->
    <header class="bg-white border-b sticky top-0 z-10 px-4 py-3 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-indigo-600 cursor-pointer" onclick="navigateTo('feed')">Perspective</h1>
        <div id="nav-controls" class="space-x-2">
            <!-- Buttons will be injected here -->
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="max-w-4xl mx-auto p-4 md:p-8">
        <div id="loading" class="text-center py-20 text-gray-500">Initializing...</div>
        <div id="view-container"></div>
    </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged, 
  signOut 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  onSnapshot, 
  addDoc, 
  serverTimestamp, 
  doc, 
  getDoc 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBeslEXxh_2j9dLiwAgeRL3p11iqgWfMgo",
  authDomain: "pulsenet-d1fe0.firebaseapp.com",
  projectId: "pulsenet-d1fe0",
  storageBucket: "pulsenet-d1fe0.firebasestorage.app",
  messagingSenderId: "816402062445",
  appId: "1:816402062445:web:cf7ce7eb9c57c1ef2fb364",
  measurementId: "G-MDN646R1XP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// State
let currentUser = null;
let currentView = 'feed';
let viewParams = {};
let feedUnsubscribe = null;

// DOM
const navControls = document.getElementById('nav-controls');
const viewContainer = document.getElementById('view-container');
const loadingEl = document.getElementById('loading');

// üî• AUTH CHECK (NO ANONYMOUS LOGIN)
onAuthStateChanged(auth, (user) => {
    if(user){
        currentUser = user;
        loadingEl.classList.add('hidden');
        renderNav();
        navigateTo('feed');
    } else {
        window.location.href = "login.html";
    }
});

// Navigation
window.navigateTo = (view, params = {}) => {
    if(currentView==='feed' && view!=='feed' && feedUnsubscribe){
        feedUnsubscribe();
        feedUnsubscribe = null;
    }
    currentView=view; 
    viewParams=params;
    renderView();
};

function renderNav(){
    navControls.innerHTML = `
        <button onclick="navigateTo('new-story')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">
            New Story
        </button>
        <button onclick="handleLogout()" class="border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50">
            Logout
        </button>
    `;
}

window.handleLogout = async () => {
    await signOut(auth);
    window.location.href = "login.html";
};

// Views
function renderView(){
    viewContainer.innerHTML = "";

    switch(currentView){
        case 'feed': renderFeed(); break;
        case 'new-story': renderNewStory(); break;
        case 'post-detail': renderPostDetail(viewParams.id); break;
    }
}

// Feed
function renderFeed(){
    viewContainer.innerHTML = `
        <h2 class="text-xl font-bold mb-6">Latest Perspectives</h2>
        <div id="posts-list" class="space-y-4"></div>
    `;

    const postsList = document.getElementById('posts-list');
    const postsCol = collection(db,"posts");

    feedUnsubscribe = onSnapshot(postsCol, snapshot=>{
        const posts = snapshot.docs.map(d=>({id:d.id, ...d.data()}));
        posts.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));

        postsList.innerHTML = posts.length ? "" : 
            '<p class="text-gray-500 text-center py-10">No stories yet.</p>';

        posts.forEach(post=>{
            const card = document.createElement('div');
            card.className="post-card bg-white p-6 rounded-xl border shadow-sm cursor-pointer";
            card.innerHTML=`
                <h3 class="text-xl font-semibold mb-2">${escapeHtml(post.title)}</h3>
                <p class="text-gray-600 mb-4">${escapeHtml(post.content?.slice(0,150))}...</p>
                <div class="text-sm text-gray-400 flex justify-between">
                    <span>${escapeHtml(post.authorName || "Anonymous")}</span>
                </div>
            `;
            card.onclick = ()=>navigateTo('post-detail',{id:post.id});
            postsList.appendChild(card);
        });
    });
}

// New Story
function renderNewStory(){
    viewContainer.innerHTML=`
        <div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-sm border">
            <h2 class="text-2xl font-bold mb-6">Write a Story</h2>
            <form id="story-form" class="space-y-4">
                <input type="text" id="title" placeholder="Title" required class="w-full p-3 border rounded-lg">
                <textarea id="content" rows="8" placeholder="Content" required class="w-full p-3 border rounded-lg"></textarea>
                <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg">Publish</button>
            </form>
        </div>
    `;

    document.getElementById('story-form').onsubmit=async e=>{
        e.preventDefault();

        await addDoc(collection(db,"posts"),{
            title: document.getElementById('title').value,
            content: document.getElementById('content').value,
            authorId: currentUser.uid,
            authorName: currentUser.displayName || "Anonymous",
            createdAt: serverTimestamp()
        });

        navigateTo('feed');
    };
}

// Post Detail
async function renderPostDetail(id){
    const docRef = doc(db,"posts",id);
    const snap = await getDoc(docRef);

    if(!snap.exists()){
        viewContainer.innerHTML="<p>Post not found.</p>";
        return;
    }

    const post = snap.data();

    viewContainer.innerHTML=`
        <button onclick="navigateTo('feed')" class="text-indigo-600 mb-6">‚Üê Back</button>
        <article class="bg-white p-8 rounded-2xl shadow-sm border">
            <h2 class="text-4xl font-bold mb-4">${escapeHtml(post.title)}</h2>
            <div class="text-gray-500 text-sm mb-8">By ${escapeHtml(post.authorName)}</div>
            <div class="whitespace-pre-wrap">${escapeHtml(post.content)}</div>
        </article>
    `;
}

// Helpers
function escapeHtml(text){
    const div=document.createElement('div');
    div.textContent=text;
    return div.innerHTML;
}
</script>
</body>
</html>
