<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comments / Reply</title>
<style>
body { font-family:sans-serif; padding:20px; background:#FDFDFF; color:#111; }
h1 { font-size: 1.5rem; margin-bottom: 20px; }
textarea { 
  width:100%; 
  margin-bottom:15px; 
  padding: 10px; 
  border-radius: 8px; 
  border: 1px solid #ccc; 
  font-family: inherit;
  box-sizing: border-box;
}
/* Matching Button Style */
.btn-dark { 
  background:#111; 
  color:#fff; 
  padding:10px 18px; 
  border-radius:5px; 
  border:1px solid #ccc; 
  cursor:pointer; 
  font-family:inherit;
  margin-right: 5px;
}
.btn-dark:disabled { background: #666; cursor: not-allowed; }
</style>
</head>
<body>

<h1 id="post-title">Loading...</h1>
<div id="add-comment">
  <textarea id="comment-text" rows="5" placeholder="Write your thoughts..."></textarea>
  <div class="actions">
    <button id="submit-comment" class="btn-dark">Post Comment</button>
    <button id="cancel-btn" class="btn-dark" style="background: #fff; color: #111;">Cancel</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBeslEXxh_2j9dLiwAgeRL3p11iqgWfMgo",
  authDomain: "pulsenet-d1fe0.firebaseapp.com",
  projectId: "pulsenet-d1fe0",
  storageBucket: "pulsenet-d1fe0.firebasestorage.app",
  messagingSenderId: "816402062445",
  appId: "1:816402062445:web:cf7ce7eb9c57c1ef2fb364"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "pulsenet-d1fe0";

const postTitle = document.getElementById("post-title");
const commentText = document.getElementById("comment-text");
const submitCommentBtn = document.getElementById("submit-comment");
const cancelBtn = document.getElementById("cancel-btn");

const params = new URLSearchParams(window.location.search);
const postId = params.get("postId");
const replyTo = params.get("replyTo");

let currentUser = null;
onAuthStateChanged(auth, user => {
  currentUser = user;
  if(!user) {
    commentText.placeholder = "Please login to comment";
    commentText.disabled = true;
    submitCommentBtn.disabled = true;
  }
});

async function setupPage(){
  const postDoc = await getDoc(doc(db,"artifacts",appId,"public","data","posts",postId));
  if(postDoc.exists()) postTitle.textContent = postDoc.data().title;
  
  if(replyTo) {
    commentText.value = `@${replyTo} `;
    commentText.focus();
  }
}
setupPage();

submitCommentBtn.onclick = async ()=>{
  const text = commentText.value.trim();
  if(!text || !currentUser) return;
  
  await updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{
    comments: arrayUnion({
      text,
      authorName: currentUser.displayName || "Anonymous",
      authorId: currentUser.uid,
      createdAt: new Date().toISOString()
    })
  });
  window.history.back();
};

cancelBtn.onclick = ()=>window.history.back();
</script>
</body>
</html>
