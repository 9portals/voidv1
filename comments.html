<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comments</title>
<style>
body { font-family:sans-serif; padding:20px; }
.comment { border-bottom:1px solid #ddd; padding:10px 0; display:flex; justify-content:space-between; align-items:center; }
textarea { width:100%; margin-bottom:5px; }
button { padding:8px 12px; cursor:pointer; margin:2px; }
</style>
</head>
<body>

<h1 id="post-title"></h1>
<div id="comments-list"></div>

<div id="add-comment">
  <textarea id="comment-text" rows="3" placeholder="Add a comment..."></textarea>
  <button id="submit-comment">Post Comment</button>
  <button id="cancel-btn">Cancel</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBeslEXxh_2j9dLiwAgeRL3p11iqgWfMgo",
  authDomain: "pulsenet-d1fe0.firebaseapp.com",
  projectId: "pulsenet-d1fe0",
  storageBucket: "pulsenet-d1fe0.firebasestorage.app",
  messagingSenderId: "816402062445",
  appId: "1:816402062445:web:cf7ce7eb9c57c1ef2fb364"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "pulsenet-d1fe0";

// DOM
const postTitle = document.getElementById("post-title");
const commentsList = document.getElementById("comments-list");
const commentText = document.getElementById("comment-text");
const submitCommentBtn = document.getElementById("submit-comment");
const cancelBtn = document.getElementById("cancel-btn");

let currentUser = null;
onAuthStateChanged(auth, user => {
  currentUser = user;
  commentText.disabled = !user;
  submitCommentBtn.disabled = !user;
});

// URL params
const params = new URLSearchParams(window.location.search);
const postId = params.get("postId");
const replyTo = params.get("replyTo") || null;

async function loadComments() {
  const postDoc = await getDoc(doc(db,"artifacts",appId,"public","data","posts",postId));
  if(!postDoc.exists()) return alert("Post not found!");
  const post = postDoc.data();

  postTitle.textContent = post.title;
  commentsList.innerHTML = (post.comments||[]).map(c=>`
    <div class="comment"><b>${c.authorName}</b>: ${c.text}
      <button class="reply-btn">Reply</button>
      <button class="like-comment-btn">‚ù§Ô∏è ${c.likes||0}</button>
      <button class="burn-comment-btn">üî• ${c.burns||0}</button>
    </div>
  `).join("");

  // Attach event listeners
  Array.from(commentsList.querySelectorAll(".reply-btn")).forEach((btn,i)=>{
    btn.onclick = ()=> window.location.href=`comments.html?postId=${postId}&replyTo=${post.comments[i].authorId}`;
  });

  Array.from(commentsList.querySelectorAll(".like-comment-btn")).forEach((btn,i)=>{
    btn.onclick = async ()=>{
      if(!currentUser) return alert("Login to react!");
      post.comments[i].likes = (post.comments[i].likes||0)+1;
      await updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{comments: post.comments});
      loadComments();
    };
  });

  Array.from(commentsList.querySelectorAll(".burn-comment-btn")).forEach((btn,i)=>{
    btn.onclick = async ()=>{
      if(!currentUser) return alert("Login to react!");
      post.comments[i].burns = (post.comments[i].burns||0)+1;
      await updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{comments: post.comments});
      loadComments();
    };
  });
}

// Submit comment
submitCommentBtn.onclick = async ()=>{
  if(!currentUser) return alert("Login to comment!");
  const text = commentText.value.trim();
  if(!text) return;
  const postRef = doc(db,"artifacts",appId,"public","data","posts",postId);
  await updateDoc(postRef,{
    comments: arrayUnion({
      text,
      authorName: currentUser.displayName||"Anonymous",
      authorId: currentUser.uid,
      replyTo: replyTo,
      createdAt: new Date().toISOString()
    })
  });
  commentText.value="";
  loadComments();
};

// Cancel button
cancelBtn.onclick = ()=>window.history.back();

loadComments();
</script>
</body>
</html>
