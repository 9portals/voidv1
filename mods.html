<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pulsenet - Moderator Panel</title>
<style>
body { font-family:sans-serif; background:#FDFDFF; color:#111; margin:0; padding:20px; }
header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; }
h1 { margin-bottom:20px; }
.btn-dark { background:#111; color:#fff; padding:8px 12px; border-radius:5px; border:1px solid #ccc; cursor:pointer; font-family:inherit; text-decoration: none; display:inline-block; }
button { cursor:pointer; margin:5px; padding:8px 12px; border-radius:8px; border:none; font-family:inherit; display:none; }
.post { border:1px solid #ddd; padding:20px; border-radius:15px; margin-bottom:20px; position:relative; }
.meta { font-size:13px; color:#666; margin-bottom:8px; }
.reaction-btn { margin-right:10px; cursor:pointer; display: inline-block; }
.comments { margin-top:20px; }
.comment { border-top:1px solid #eee; padding:12px 0; display:flex; justify-content:space-between; align-items:center; }
.comment b, .author-name { margin-right:5px; cursor:pointer; color:#111; text-decoration:none; }
.edit-btn, .delete-btn { padding:4px 8px; font-size:0.8em; margin-left:5px; }
.comment-controls { margin-left:10px; }
</style>
</head>
<body>

<header>
<h1>Moderator Panel</h1>
<div id="top-buttons">
<button id="login-btn">Login / Register</button>
<button id="account-btn">Account</button>
<button id="logout-btn">Logout</button>
</div>
</header>

<div id="posts-container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, doc, onSnapshot, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBeslEXxh_2j9dLiwAgeRL3p11iqgWfMgo",
  authDomain: "pulsenet-d1fe0.firebaseapp.com",
  projectId: "pulsenet-d1fe0",
  storageBucket: "pulsenet-d1fe0.firebasestorage.app",
  messagingSenderId: "816402062445",
  appId: "1:816402062445:web:cf7ce7eb9c57c1ef2fb364"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "pulsenet-d1fe0";
const postsCol = collection(db,"artifacts",appId,"public","data","posts");

const postsContainer = document.getElementById("posts-container");
const loginBtn = document.getElementById("login-btn");
const accountBtn = document.getElementById("account-btn");
const logoutBtn = document.getElementById("logout-btn");

let currentUser = null;
const modUIDs = ["PUT_MOD_UID_HERE"]; // add mods UID list

loginBtn.onclick = ()=>window.location.href="login.html";
accountBtn.onclick = ()=>window.location.href="account.html";
logoutBtn.onclick = ()=>signOut(auth);

onAuthStateChanged(auth,user=>{
  if(!user) return postsContainer.innerHTML="<p>Please login first.</p>";
  currentUser=user;
  if(!modUIDs.includes(user.uid)) return postsContainer.innerHTML="<p>You are not authorized.</p>";
  loadPosts();
});

function loadPosts(){
  onSnapshot(postsCol, snapshot=>{
    postsContainer.innerHTML="";
    const docs = snapshot.docs.sort((a,b)=>{
      return (b.data().createdAt?.seconds||0) - (a.data().createdAt?.seconds||0);
    });

    docs.forEach(docSnap=>{
      const post = docSnap.data();
      const postId = docSnap.id;

      const div = document.createElement("div");
      div.className="post";

      div.innerHTML = `
        <div class="meta"><b class="author-name" data-uid="${post.authorId}">${escapeHTML(post.authorName||"Anonymous")}</b> ‚Ä¢ ${post.createdAt?.seconds ? new Date(post.createdAt.seconds*1000).toLocaleString() : ""}</div>
        <h3>${escapeHTML(post.title)}</h3>
        <p>${escapeHTML(post.content)}</p>
        <div>
          <button class="edit-btn btn-dark">Edit Post</button>
          <button class="delete-btn btn-dark">Delete Post</button>
        </div>
        <div class="reactions">
          <button class="reaction-btn" data-type="like">‚ù§Ô∏è ${post.reactions?.like||0}</button>
          <button class="reaction-btn" data-type="fire">üî• ${post.reactions?.fire||0}</button>
          <button class="reaction-btn" data-type="insight">üí° ${post.reactions?.insight||0}</button>
        </div>
        <div class="comments">
          <h4>Comments & Replies</h4>
          <div class="comments-list">
            ${(post.comments||[]).map((c,i)=>`
              <div class="comment" data-index="${i}">
                <div>
                  <b class="comment-user" data-uid="${c.authorId}">${escapeHTML(c.authorName)}</b>: ${escapeHTML(c.text)}
                  <span class="comment-controls">
                    <button class="edit-comment btn-dark">Edit</button>
                    <button class="delete-comment btn-dark">Delete</button>
                  </span>
                </div>
              </div>`).join("")}
          </div>
        </div>
      `;

      postsContainer.appendChild(div);

      div.querySelector(".delete-btn").onclick = async ()=>{
        if(confirm("Delete this post?")) await deleteDoc(doc(db,"artifacts",appId,"public","data","posts",postId));
      };

      div.querySelector(".edit-btn").onclick = async ()=>{
        const newTitle = prompt("New Title:", post.title);
        const newContent = prompt("New Content:", post.content);
        if(newTitle!==null && newContent!==null){
          await updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{title:newTitle,content:newContent});
        }
      };

      div.querySelectorAll(".reaction-btn").forEach(btn=>{
        btn.onclick = async ()=>{
          await updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{[`reactions.${btn.dataset.type}`]: increment(1)});
        };
      });

      const authorEl = div.querySelector(".author-name");
      if(authorEl) authorEl.onclick = ()=> window.location.href=`account.html?uid=${authorEl.dataset.uid}`;

      div.querySelectorAll(".comment").forEach(commentEl=>{
        const idx = commentEl.dataset.index;
        const editBtn = commentEl.querySelector(".edit-comment");
        const deleteBtn = commentEl.querySelector(".delete-comment");

        editBtn.onclick = async ()=>{
          const newText = prompt("Edit comment:", post.comments[idx].text);
          if(newText!==null){
            const updatedComments = [...post.comments];
            updatedComments[idx].text = newText;
            await updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{comments: updatedComments});
          }
        };

        deleteBtn.onclick = async ()=>{
          if(confirm("Delete this comment?")){
            const updatedComments = post.comments.filter((_,i)=>i!=idx);
            await updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{comments: updatedComments});
          }
        };

        const userEl = commentEl.querySelector(".comment-user");
        if(userEl) userEl.onclick = ()=> window.location.href=`account.html?uid=${userEl.dataset.uid}`;
      });
    });
  });
}

function escapeHTML(str){
  return str?.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
}
</script>

</body>
</html>
