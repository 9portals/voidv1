<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pulsenet - Admin Panel</title>
<style>
body { font-family:sans-serif; background:#FDFDFF; color:#111; margin:0; padding:20px; }
h1 { margin-bottom:20px; }
.post { border:1px solid #ddd; padding:15px; border-radius:15px; margin-bottom:15px; position:relative; }
.button { background:#111; color:#fff; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; margin-right:5px; }
.button-small { padding:4px 8px; font-size:0.9em; }
.hidden { display:none; }
.meta { font-size:13px; color:#666; margin-bottom:8px; }
</style>
</head>
<body>

<h1>Admin Panel</h1>
<p id="status">Loading...</p>
<div id="posts-container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, doc, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBeslEXxh_2j9dLiwAgeRL3p11iqgWfMgo",
  authDomain: "pulsenet-d1fe0.firebaseapp.com",
  projectId: "pulsenet-d1fe0",
  storageBucket: "pulsenet-d1fe0.firebasestorage.app",
  messagingSenderId: "816402062445",
  appId: "1:816402062445:web:cf7ce7eb9c57c1ef2fb364"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "pulsenet-d1fe0";
const postsCol = collection(db,"artifacts",appId,"public","data","posts");

const postsContainer = document.getElementById("posts-container");
const statusEl = document.getElementById("status");

let currentUser = null;

/* Admin users list - UID of admins/mods */
const adminUIDs = [
  "ADMIN_UID_1",
  "ADMIN_UID_2"
];

/* Auth check */
onAuthStateChanged(auth, user => {
  if(!user) {
    statusEl.textContent = "Please login first.";
    return;
  }
  currentUser = user;
  if(!adminUIDs.includes(user.uid)) {
    statusEl.textContent = "You are not authorized to view this page.";
    return;
  }
  statusEl.textContent = `Welcome, ${user.displayName || "Admin"} | UID: ${user.uid} `;
  loadPosts();
});

/* Load posts with admin actions */
function loadPosts(){
  onSnapshot(postsCol, snapshot=>{
    postsContainer.innerHTML = "";
    const docs = snapshot.docs.sort((a,b)=>{
      return (b.data().createdAt?.seconds||0) - (a.data().createdAt?.seconds||0);
    });

    docs.forEach(docSnap=>{
      const post = docSnap.data();
      const postId = docSnap.id;

      const div = document.createElement("div");
      div.className = "post";

      div.innerHTML = `
        <div class="meta"><b>${escapeHTML(post.authorName||"Anonymous")}</b> â€¢ ${post.createdAt?.seconds ? new Date(post.createdAt.seconds*1000).toLocaleString() : ""}</div>
        <h3>${escapeHTML(post.title)}</h3>
        <p>${escapeHTML(post.content)}</p>
        <div>
          <button class="button button-small edit-btn">Edit</button>
          <button class="button button-small delete-btn">Delete</button>
        </div>
      `;

      postsContainer.appendChild(div);

      /* Delete post */
      div.querySelector(".delete-btn").onclick = async ()=>{
        if(confirm("Are you sure you want to delete this post?")){
          await deleteDoc(doc(db,"artifacts",appId,"public","data","posts",postId));
          alert("Post deleted.");
        }
      };

      /* Edit post */
      div.querySelector(".edit-btn").onclick = async ()=>{
        const newTitle = prompt("New Title:", post.title);
        const newContent = prompt("New Content:", post.content);
        if(newTitle !== null && newContent !== null){
          await updateDoc(doc(db,"artifacts",appId,"public","data","posts",postId),{
            title: newTitle,
            content: newContent
          });
          alert("Post updated.");
        }
      };
    });
  });
}

/* Escape HTML */
function escapeHTML(str){
  return str?.replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",
    '"':"&quot;","'":"&#039;"
  }[m]));
}
</script>
</body>
</html>
